# NEW GENESIS v1.1 Upgrade Summary

**Date:** 2026-01-22
**Upgrade:** v1.0 (Shatter Protocol) â†’ v1.1 (Automated Team)
**Key Innovation:** Real-time Linear task updates via MCP Gateway

---

## What Changed

### Core Problem Solved

**v1.0 Gap:** Agents executed shards silently. Linear tasks only updated at milestone boundaries via `indiana_milestone.js`. No real-time visibility into shard progress.

**v1.1 Solution:** MCP Gateway allows agents to update Linear tasks in real-time during shard execution. User sees "In Progress" â†’ "Done" status changes live.

---

## New Files Created

### 1. MCP Server
- **File:** `plugins/n8n-gateway.js`
- **Purpose:** Stdio MCP server providing `start_shard` and `complete_shard` tools
- **Transport:** @modelcontextprotocol/sdk
- **Dependencies:** Defined in `plugins/package.json`

### 2. Test Script
- **File:** `scripts/test-gateway.js`
- **Purpose:** Verify n8n webhook connection without needing a full Genesis project
- **Usage:** `node scripts/test-gateway.js start_shard ANT-001`

### 3. Installation Script
- **File:** `scripts/install-gateway.js`
- **Purpose:** Automates MCP server setup for Claude Code or OpenCode
- **Usage:** `node scripts/install-gateway.js claude-code`

### 4. Documentation
- **File:** `docs/AGENT_MCP_TOOLS.md`
- **Purpose:** Quick reference for agents on how to use the MCP tools
- **Audience:** AI agents executing shards

- **File:** `plugins/README.md` (updated)
- **Purpose:** Installation and troubleshooting guide for humans

- **File:** `docs/V1.1_UPGRADE_SUMMARY.md` (this file)
- **Purpose:** Upgrade overview and migration guide

---

## How It Works

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent (Claude/GPT-4) Executes Shard M01_01                  â”‚
â”‚                                                              â”‚
â”‚  1. start_shard({ shardId: "M01_01" })                       â”‚
â”‚     â†“                                                        â”‚
â”‚  2. MCP Gateway reads .antigravity/PROJECT_IDS.json         â”‚
â”‚     â†“                                                        â”‚
â”‚  3. Maps: M01_01 â†’ TASK-001 â†’ ANT-220                        â”‚
â”‚     â†“                                                        â”‚
â”‚  4. POST https://ai.bsbsbs.au/webhook/genesis-update        â”‚
â”‚     {                                                        â”‚
â”‚       "action": "start_shard",                               â”‚
â”‚       "linearHandle": "ANT-220",                             â”‚
â”‚       "notes": "Shard M01_01 started"                        â”‚
â”‚     }                                                        â”‚
â”‚     â†“                                                        â”‚
â”‚  5. n8n Workflow updates Linear task ANT-220 â†’ "In Progress" â”‚
â”‚                                                              â”‚
â”‚  [Agent executes shard: reads files, writes code, verifies] â”‚
â”‚                                                              â”‚
â”‚  6. complete_shard({ shardId: "M01_01", notes: "..." })      â”‚
â”‚     â†“                                                        â”‚
â”‚  7. MCP Gateway maps M01_01 â†’ ANT-220                        â”‚
â”‚     â†“                                                        â”‚
â”‚  8. POST webhook with action: "complete_shard"              â”‚
â”‚     â†“                                                        â”‚
â”‚  9. n8n Workflow updates Linear task ANT-220 â†’ "Done"        â”‚
â”‚                                                              â”‚
â”‚  10. Agent exits (amnesia architecture preserved)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Components

1. **MCP Gateway (plugins/n8n-gateway.js)**
   - Provides tools: `start_shard`, `complete_shard`
   - Reads PROJECT_IDS.json for shard â†’ Linear mappings
   - Posts to n8n webhook

2. **n8n Webhook (https://ai.bsbsbs.au/webhook/genesis-update)**
   - Receives: `{ action, linearHandle, notes }`
   - Updates Linear task status via Linear API
   - Returns success confirmation

3. **PROJECT_IDS.json**
   - Created by `node scripts/indiana.js` during Genesis
   - Maps: TASK-001 â†’ ANT-220 (Linear identifier)
   - Used by MCP Gateway to resolve shard â†’ Linear task

4. **Agent Workflow**
   - Receives shard context (BRIEF.md + STACK.md + shard file)
   - Calls `start_shard` at beginning
   - Executes work
   - Calls `complete_shard` at end
   - Exits (amnesia preserved)

---

## Installation

### Quick Start

```bash
# 1. Install dependencies
cd ~/.antigravity/new_genesis/plugins
npm install

# 2. Run auto-installer (for Claude Code)
node ../scripts/install-gateway.js claude-code

# 3. Restart Claude Code

# 4. Test the connection
node ../scripts/test-gateway.js start_shard ANT-001
```

### Manual Setup (Claude Code)

Edit `~/.claude/mcp.json`:

```json
{
  "mcpServers": {
    "genesis-gateway": {
      "command": "node",
      "args": ["C:/Users/Corsa/.antigravity/new_genesis/plugins/n8n-gateway.js"],
      "env": {
        "GENESIS_WEBHOOK_URL": "https://ai.bsbsbs.au/webhook/genesis-update"
      }
    }
  }
}
```

Restart Claude Code.

### Manual Setup (OpenCode)

Add to your project's `opencode.json`:

```json
{
  "mcp": {
    "genesis-gateway": {
      "command": "node",
      "args": ["../.antigravity/new_genesis/plugins/n8n-gateway.js"],
      "env": {
        "GENESIS_WEBHOOK_URL": "https://ai.bsbsbs.au/webhook/genesis-update"
      }
    }
  }
}
```

---

## Testing

### Test 1: Verify Webhook Connection

```bash
node scripts/test-gateway.js start_shard ANT-001
```

**Expected Output:**
```
ğŸ”§ Testing n8n Gateway Connection

Webhook URL: https://ai.bsbsbs.au/webhook/genesis-update
Payload: {
  "action": "start_shard",
  "linearHandle": "ANT-001",
  "notes": "Test start_shard from test-gateway.js",
  "timestamp": "2026-01-22T..."
}

ğŸ“¡ Sending request...

ğŸ“Š Response Status: 200 OK
âœ… Response Body: { "success": true }
âœ¨ Test successful!
```

### Test 2: Verify MCP Server Loaded

**Claude Code:**
```bash
claude mcp list
# Should show: genesis-gateway
```

**OpenCode:**
```bash
# Check tools are available in agent context
# Agent should see: start_shard, complete_shard
```

### Test 3: End-to-End Shard Execution

Create a test project:
```bash
cd ~/.antigravity/projects/test-gateway
# Ensure PROJECT_IDS.json exists
# Run a shard and verify Linear updates
```

---

## n8n Workflow Requirements

Your n8n workflow at `https://ai.bsbsbs.au/webhook/genesis-update` must:

### Input Schema

```json
{
  "action": "start_shard" | "complete_shard",
  "linearHandle": "ANT-###",
  "notes": "Optional notes",
  "timestamp": "ISO 8601 timestamp"
}
```

### Actions Required

**When action = "start_shard":**
1. Find Linear task by identifier (ANT-###)
2. Update status to "In Progress"
3. Optionally add comment with notes

**When action = "complete_shard":**
1. Find Linear task by identifier (ANT-###)
2. Update status to "Done"
3. Add comment with notes (if provided)

### Response Format

```json
{
  "success": true,
  "linearTaskId": "...",
  "status": "In Progress" | "Done"
}
```

---

## Migration from v1.0

### For Existing Projects

**No changes required.** v1.1 is backward compatible:

- Old projects without MCP tools still work
- `indiana_milestone.js` still updates Linear at milestone boundaries
- New projects get real-time updates via MCP Gateway

### For New Projects

**Recommended workflow:**

1. @Manager runs `node scripts/indiana.js` â†’ Creates PROJECT_IDS.json
2. @Developer executes shards:
   - Calls `start_shard({ shardId: "M01_01" })` at start
   - Executes shard work
   - Calls `complete_shard({ shardId: "M01_01", notes: "..." })` at end
3. Linear board shows real-time progress
4. User sees which shards are active/complete without checking local files

---

## Differences from v1.0

| Aspect | v1.0 (Shatter) | v1.1 (Automated Team) |
|--------|----------------|------------------------|
| **Linear Updates** | Manual via indiana_milestone.js | Automatic via MCP tools |
| **Update Frequency** | Once per milestone | Once per shard |
| **Visibility** | Local progress.json only | Linear board (live) |
| **Agent Workflow** | Execute + exit | start â†’ execute â†’ complete â†’ exit |
| **User Experience** | Check local files | Check Linear board |
| **Script Calls** | Required at milestones | Optional (tools handle it) |

---

## Known Limitations

### 1. Shard â†’ Task Mapping

**Issue:** PROJECT_IDS.json maps TASK-001 â†’ ANT-220, but shards are named M01_01.

**Current Solution:** MCP Gateway tries multiple strategies:
- Direct lookup: `TASK-001` â†’ `ANT-220`
- Pattern matching: `M01_01` â†’ sequential TASK-XXX
- Shard reference: Check if task has `shardId` field

**Ideal Solution (TODO):** Update `indiana.js` to include shard mappings:
```json
{
  "tasks": {
    "TASK-001": { "linearIdentifier": "ANT-220", "shardId": "M01_01" }
  }
}
```

### 2. Parallel Shard Execution

**Issue:** If multiple shards run in parallel, they could update same Linear task.

**Current Solution:** v1.1 assumes sequential execution (one shard at a time).

**Future Solution (v1.2+):** Add locking mechanism or task queue.

### 3. Manual Shard Completion

**Issue:** If user manually completes a shard, MCP tools not called.

**Current Solution:** Run `node scripts/genesis_complete.js M01_01` to trigger webhook.

**Future Solution (v1.2+):** Orchestrator handles all updates, not agents.

---

## Next Steps

### Immediate (Today)

1. âœ… Test webhook connection: `node scripts/test-gateway.js start_shard ANT-001`
2. â³ Verify Linear task ANT-001 status changed in Linear app
3. â³ Install MCP Gateway: `node scripts/install-gateway.js claude-code`
4. â³ Restart Claude Code
5. â³ Create test project and verify tools available

### Short-term (This Week)

1. â³ Update n8n workflow to handle `genesis-update` webhook
2. â³ Test end-to-end: Create project â†’ Execute shard â†’ Verify Linear updates
3. â³ Update PROJECT_IDS.json structure to include shard mappings
4. â³ Document agent workflow in ROLE_DEVELOPER.md

### Medium-term (This Month)

1. â³ Migrate existing v1.0 projects to v1.1 (optional)
2. â³ Build orchestrator that calls MCP tools (remove dependency on agents)
3. â³ Add error recovery (if webhook fails, queue for retry)
4. â³ Create dashboard showing shard progress in real-time

---

## Success Criteria

v1.1 is successfully deployed when:

- âœ… MCP Gateway installed and running
- â³ Test script confirms webhook connection
- â³ Agent can call `start_shard` and `complete_shard` tools
- â³ Linear tasks update in real-time during shard execution
- â³ User sees "In Progress" â†’ "Done" status changes live
- â³ No breaking changes to v1.0 projects

---

**NEW GENESIS v1.1 (Automated Team)** - Real-time Linear updates via MCP Gateway.

**Key Innovation:** Agents now have "hands" to update Linear tasks during execution, not just after milestones complete.
